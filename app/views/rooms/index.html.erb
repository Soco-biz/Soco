<head>
  <% @page_title = "部屋一覧" %> 
  <meta http-equiv="content-type" charset="utf-8">
      <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script type="text/javascript" src="//maps.google.com/maps/api/js?key=AIzaSyCd3SCSn16uIQTi4MbNJ1QtDRCYMce44Yk&sensor=false"></script>
</head>
<div class="room_name"><img src="/list.png"> 部屋リスト</div>
  <div class="rooms">
  <ul>
  <div　class="roomlist" id="roomlist">
    <div class="loading" id="loading">
      <img src="./loading.gif">
      <br />位置情報を取得しています<br/><br/>
    </div>
    <a href="/rooms/0"><li>ラウンジ</li></a>
    <a href="/rooms/new"><li>+ 新たに部屋を作る</li></a>
  </div>
  </ul>
</div>
     <script>
      window.onload = getLocation();
      // setInterval(getLocation, 60000);
function getLocation(){
        var geocoder;
        navigator.geolocation.getCurrentPosition(is_success,is_error);
        function is_success(position) {
          var gpsLat = position.coords.latitude;
          var gpsLng = position.coords.longitude;
         
          gmap_init(gpsLat,gpsLng);
        }
        function is_error(error) {
          var result = "";
          switch(error.code) {
            case 1:
              result = '位置情報の取得が許可されていません';
            break;
            case 2:
              result = '位置情報の取得に失敗';
            break;
            case 3:
              result = 'タイムアウト';
            break;
          }
        }
        
        // googlemap init
        function gmap_init(gpsLat,gpsLng) {
          var geocoder = new google.maps.Geocoder();
          var latlng = new google.maps.LatLng(gpsLat,gpsLng);
         
          geocoder.geocode({'latLng':latlng},function(results,status){
            if (status == google.maps.GeocoderStatus.OK) {
              console.log(results[1].formatted_address);
              result  = '現在地の取得に成功<br>';
              result += '経度：' + gpsLat + '<br>';
              result += '緯度：' + gpsLng + '<br>';
              result += '住所：' + results[0].formatted_address + '<br>';
              userLat = gpsLat;
              userLng = gpsLng;
              roomlist();
              $("#loading").remove();
            } else {
              console.log(status);
            }
          });
        }
}

        var roomlist = function(){
          parseFloat(userLat);
          parseFloat(userLng);
          $.ajax({
            url: location.href, 
            type: 'GET', 
            data: {
              longitude: userLng,
              latitude: userLat
            },
            dataType: 'json'
          })
          .then(function(data){ 
            if(data.length > 0){
              $.each(data, function(i, data){
                $('#roomlist').prepend('<a href="/rooms/'+ data['id']  + '?name=' + data['name'] + '"><li>' + data['name'] + '</li></a>');
              })
            }
          })
        }
      </script>