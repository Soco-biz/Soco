<% @page_title = @room.name %> 
<script src="//code.jquery.com/jquery-3.0.0.min.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script type="text/javascript" src="//maps.google.com/maps/api/js?key=AIzaSyCd3SCSn16uIQTi4MbNJ1QtDRCYMce44Yk&sensor=false"></script>
<div class="loading" id="loading">
  <img src="/loading.gif">
  <br />位置情報を取得しています<br/>
</div>

<div id="timeline" class="timeline">
  <% unless @posts.present? %>
  <div class="notification">まだ投稿がありません<br />最初の<a href="/new?room_id=<%= @room_id %>">投稿</a>をしませんか？</div>
  <% end %>
  <% first_flag = 0 %>
  <% @posts.each do |post|  %>
  <div class="post" id="content">
    <div class="text_body">
      <%= raw(hbr(post.content)) %>
    </div>
    <%= if post.image.present? then link_to post.image, :target=>["_blank"] do image_tag "#{post.image}" end end %>
    <div class="text_data">
      <% post.id %>
      <div id="<%= post.id %>" style="display:inline"><%= @postId[post.id] %></div> :
      <%= time_ago_in_words(post.created_at) %>
      <%= 
      if post.simvalue.present? then
        if post.simvalue > "0.49" then
          link_to(">>#{@postId.fetch(post.similarity.to_i)}", "\##{post.similarity}" , :id => "res#{post.similarity}")
        end
      end
      %> 
      <!--<%= link_to("☓", "/delete/#{post.id}")%> -->
    </div>
  </div>
  <% if first_flag == 0
    @last_id = post.id
    first_flag = 1
  end
  end %>
      <div id="modalwin" class="modalwin hide">
        <a herf="#" class="modal-close"></a>
        <h1><%=@room.name%>への投稿</h1>
        <div class="modalwin-contents">
          <%= form_tag("/create") do %>
          <div class="form-body">
            <div class="form_wrapper">
              <textarea id="content" cols="30" rows="10" name="content" onkeyup="ShowLength(value);" class="post"></textarea>
              <p align="right" id="inputlength">0/300</p>
            </div>
            <label id="submit_label"  class="hoge" for="submit">
              投稿
              <input id="submit" type="submit" style="display:none;" />
            </label>
            <input name="room_id" type="hidden" value="<%= @room_id %>">
            <input id="image" name="image" type="hidden">
            <label class="hoge" for="upfile">
              +画像を追加
              <input type="file"  name="upfile" id="upfile" accept="image/*" style="display:none;" />
            </label>
            <div><img class="thumbnail" id="thumbnail" src="/thumbnail.jpg"></div>
            <input id="latitude" type="hidden" name="latitude">
            <input id="longitude" type="hidden" name="longitude">
            <% end %>
          </div>
        </div>
    <script>
      window.onload = init();
      window.onload = getLocation();
      setInterval(update, 60000);
      setInterval(getLocation, 300000);
      function ShowLength( str ) {
        document.getElementById("inputlength").innerHTML = str.length + "/300";
        form = document.getElementById("submit");
        if (str.length > 300 || locationFlag == 0){
          form.disabled = "disabled";
          $('#submit_label').css('background-color','rgba(50,50,50,0.1)');
          $('#submit_label').css('color','#888');
        }else{
          if (str.length < 301 && locationFlag == 1){
            form.disabled = "";
            $('#submit_label').css('background-color','#FF9933');
            $('#submit_label').css('color','#333');
          }
        }
      }
      $(function () {
        function showModal(event) {
          event.preventDefault();
          var $shade = $('<div></div>');
          $shade
          .attr('id', 'shade')
          .on('click', hideModal);
          var $modalWin = $('#modalwin');
          var $window = $(window);
          var posX = ($window.width() - $modalWin.outerWidth()) / 2;
          var posY = ($window.height() - $modalWin.outerHeight()) / 2;

          $modalWin
          .before($shade)
          .css({left: posX, top: posY})
          .removeClass('hide')
          .addClass('show')
          .on('click', 'button', function () {
            hideModal();
          });
        }

        function hideModal() {
          $('#shade').remove();
          $('#modalwin')
          .removeClass('show')
          .addClass('hide');
        }

        $('.show-modal').on('click', showModal);

      }());
      function init(){
        locationFlag = 0;
        counts = <%=@posts.count%>;
        postId = <%= @postId.to_json.html_safe %>;
        last_id = "<%= @last_id %>";
      }
      function update(){
        $.ajax({
          url: location.href, 
          type: 'GET', 
          data: {
            last_id: last_id
          },
          dataType: 'json'
        })
        .then(function(data){ 
          if(data.length > 0){
            $.each(data, function(i, data){
              counts = counts + 1;
              postId[data['id']] = counts;
              if(data['simvalue'] > 0.49){
                var similarity = data['similarity'];
                $('#timeline').prepend('<div class="post">' + data['content'] + '<div class="text_data">'  + postId[data['id']] + ' : less than a minute  <a href="#' + similarity  + '"> >>' + similarity  + '</a></div> </div>');
              }else{
                $('#timeline').prepend('<div class="post"><div class="text_body">' + data['content'] + '</div><div class="text_data">'  + postId[data['id']] + ' : less than a minute </div> </div>');
              }

              last_id = data['id'];
            })
          }
        }) 
      }
      function getLocation(){
        var geocoder;
        navigator.geolocation.getCurrentPosition(is_success,is_error);
        function is_success(position) {
          var gpsLat = position.coords.latitude;
          var gpsLng = position.coords.longitude;

          gmap_init(gpsLat,gpsLng);
        }
        function is_error(error) {
          var result = "";
          switch(error.code) {
            case 1:
            result = '位置情報の取得が許可されていません';
            break;
            case 2:
            result = '位置情報の取得に失敗';
            break;
            case 3:
            result = 'タイムアウト';
            break;
          }
        }
function gmap_init(gpsLat,gpsLng) {
  var geocoder = new google.maps.Geocoder();
  var latlng = new google.maps.LatLng(gpsLat,gpsLng);

  geocoder.geocode({'latLng':latlng},function(results,status){
    if (status == google.maps.GeocoderStatus.OK) {
      console.log(results[1].formatted_address);
      result  = '現在地の取得に成功<br>';
      result += '経度：' + gpsLat + '<br>';
      result += '緯度：' + gpsLng + '<br>';
      result += '住所：' + results[0].formatted_address + '<br>';
      userLat = gpsLat;
      userLng = gpsLng;
      $("#latitude").val(userLat);
      $("#longitude").val(userLng);
      checkLocation();
    } else {
      　   alert("位置情報が取得できないため、表示できません。\nトップページに戻ります");
      location.href="/";
      exit;
      console.log(status);
    }
  });
}
}
function checkLocation(){
  var startLat = <%= @startLat %>;
  var endLat = <%= @endLat %>;
  var startLng = <%= @startLng %>;
  var endLng = <%= @endLng%>;
  if(startLat < userLat　&& userLat < endLat && startLng < userLng && userLng < endLng){
    locationFlag = 1;
    $("#timeline").css("display", "block");
    $("#loading").css("display", "none");
  }else{
    alert("タイムラインの範囲以内にいないため、表示できません。\nトップページに戻ります");
    location.href="/";
    exit;
  }

}
$('#upfile').change(function(){
  if (this.files.length > 0) {
    var file = this.files[0];
    var reader = new FileReader();
    reader.readAsDataURL(file);
    console.log(reader);
    reader.onload = function() {
      var height = 500;
      $('#thumbnail').attr('src', reader.result );
      var image = reader.result;
      document.getElementById('image').value=image;
    }
  }
});
</script>
